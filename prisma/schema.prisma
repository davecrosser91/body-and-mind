generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

// Legacy - kept for backward compatibility during migration
enum Category {
  FITNESS
  MINDFULNESS
  NUTRITION
  SLEEP
  LEARNING
}

enum HabitanimalType {
  FITNESS      // Guiro the Gorilla
  MINDFULNESS  // Zen the Turtle
  NUTRITION    // Greeny the Ox
  SLEEP        // Milo the Sloth
  LEARNING     // Finn the Fox
}

// NEW: Body + Mind pillars
enum Pillar {
  BODY
  MIND
}

// SubCategory enum DELETED - now using String for custom subcategories

enum Frequency {
  DAILY
  WEEKLY
  CUSTOM
}

enum WeightPreset {
  BALANCED
  ATHLETE
  RECOVERY
  KNOWLEDGE
  CUSTOM
}

enum QuoteCategory {
  MOTIVATION
  CONSISTENCY
  BODY
  MIND
  BALANCE
  ATOMIC_HABITS
}

enum Source {
  MANUAL
  WHOOP
  APPLE_HEALTH
}

enum CueType {
  TIME
  LOCATION
  AFTER_ACTIVITY
}

// ============ MODELS ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  activities        Activity[]
  habitanimals      Habitanimal[]
  whoopConnection   WhoopConnection?
  dailyScores       DailyScore[]
  streaks           Streak[]
  achievements      Achievement[]
  dailyGoals        DailyGoal[]
  weightConfig      WeightConfig?
  habitStacks       HabitStack[]
}

model Activity {
  id          String       @id @default(cuid())
  name        String
  pillar      Pillar
  subCategory String       // Changed from enum to string for custom subcategories
  frequency   Frequency    @default(DAILY)
  description String?
  points      Int          @default(25)
  isHabit     Boolean      @default(true)  // true = recurring habit
  cueType     CueType?
  cueValue    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  archived    Boolean      @default(false)

  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  completions ActivityCompletion[]

  @@index([userId])
  @@index([pillar])
  @@index([subCategory])
}

model ActivityCompletion {
  id           String    @id @default(cuid())
  completedAt  DateTime  @default(now())
  pointsEarned Int       // snapshot of points at completion
  details      String?
  source       Source    @default(MANUAL)

  activityId   String
  activity     Activity  @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([completedAt])
}

model Habitanimal {
  id              String          @id @default(cuid())
  type            HabitanimalType
  species         String          // "gorilla", "turtle", "ox", "sloth", "fox"
  name            String          // "Guiro", "Zen", "Greeny", "Milo", "Finn"
  level           Int             @default(1)
  xp              Int             @default(0)
  health          Int             @default(100)
  evolutionStage  Int             @default(1)
  lastInteraction DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WhoopConnection {
  id            String    @id @default(cuid())
  accessToken   String
  refreshToken  String
  expiresAt     DateTime
  lastSync      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============ NEW MODELS FOR BODY + MIND SYSTEM ============

model DailyScore {
  id        String   @id @default(cuid())
  date      DateTime @db.Date

  // Main scores (0-100)
  bodyScore      Int
  mindScore      Int
  balanceIndex   Int

  // Points tracking
  bodyPoints     Int       @default(0)
  mindPoints     Int       @default(0)
  bodyComplete   Boolean   @default(false)
  mindComplete   Boolean   @default(false)

  // Body sub-scores
  trainingScore  Int?
  sleepScore     Int?
  nutritionScore Int?

  // Mind sub-scores
  meditationScore Int?
  readingScore    Int?
  learningScore   Int?

  // Whoop data snapshot (for reference)
  whoopStrain    Float?
  whoopSleep     Float?
  whoopRecovery  Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model Streak {
  id        String   @id @default(cuid())
  pillarKey String   // "BODY", "MIND", or "OVERALL"
  current   Int      @default(0)
  longest   Int      @default(0)
  lastActiveDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pillarKey])
  @@index([userId])
}

model Achievement {
  id          String   @id @default(cuid())
  type        String   // e.g., "streak_7", "streak_30", "perfect_balance", "first_workout"
  unlockedAt  DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model Quote {
  id        String        @id @default(cuid())
  text      String
  author    String?
  category  QuoteCategory
  createdAt DateTime      @default(now())

  @@index([category])
  @@index([createdAt])
}

model DailyGoal {
  id             String   @id @default(cuid())
  userId         String
  date           DateTime @db.Date
  bodyCompleted  Boolean  @default(false)
  mindCompleted  Boolean  @default(false)
  bodyActivities String[] // Activity IDs
  mindActivities String[] // Activity IDs
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
}

model WeightConfig {
  id        String       @id @default(cuid())
  userId    String       @unique
  preset    WeightPreset @default(BALANCED)

  // Body weights (must sum to 100)
  trainingWeight  Int @default(35)
  sleepWeight     Int @default(35)
  nutritionWeight Int @default(30)

  // Mind weights (must sum to 100)
  meditationWeight Int @default(40)
  readingWeight    Int @default(30)
  learningWeight   Int @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model HabitStack {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  activityIds String[] // Activity IDs in order (the actual activities)
  cueType     CueType?
  cueValue    String?  // Time (HH:mm) or location name
  isPreset    Boolean  @default(false)
  presetKey   String?  // e.g., "morning_momentum" - presets are templates, user copies them
  isActive    Boolean  @default(true)
  completionBonus Int  @default(20) // Bonus percentage when stack completed in order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions StackCompletion[]

  @@index([userId])
}

model StackCompletion {
  id                String   @id @default(cuid())
  stackId           String
  date              DateTime @db.Date
  completedAt       DateTime @default(now())
  bonusPointsEarned Int      @default(0)
  streakDay         Int      @default(1) // Which day of the streak this is

  stack HabitStack @relation(fields: [stackId], references: [id], onDelete: Cascade)

  @@unique([stackId, date])
  @@index([stackId])
  @@index([date])
}
